name: ğŸ“§ æ¯æ—¥AIçƒ­ç‚¹æŠ¥å‘Šæ¨é€

on:
  schedule:
    # æ¯å¤© UTC 00:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 8:00 AM / æ—¥æœ¬æ—¶é—´ 9:00 AM)
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send-daily-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: è·å–ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'  # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
        
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: æ›´æ–°é…ç½®æ–‡ä»¶
      run: |
        # ä½¿ç”¨GitHub Secretsæ›´æ–°é‚®ä»¶é…ç½®
        python -c "
        import yaml
        import os
        
        # è¯»å–ç°æœ‰é…ç½®
        with open('config/config.yaml', 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)
        
        # æ›´æ–°é‚®ä»¶é…ç½®
        config['notification']['webhooks']['email_from'] = os.environ.get('SENDER_EMAIL', '')
        config['notification']['webhooks']['email_password'] = os.environ.get('SENDER_PASSWORD', '')
        config['notification']['webhooks']['email_to'] = os.environ.get('RECIPIENT_EMAIL', '')
        
        # ç¡®ä¿æ¨é€æ—¶é—´çª—å£è®¾ç½®æ­£ç¡®
        config['notification']['push_window']['enabled'] = True
        config['notification']['push_window']['once_per_day'] = True
        config['notification']['push_window']['time_range']['start'] = '08:00'  # åŒ—äº¬æ—¶é—´
        config['notification']['push_window']['time_range']['end'] = '09:00'    # åŒ—äº¬æ—¶é—´
        
        # ä¿å­˜é…ç½®
        with open('config/config.yaml', 'w', encoding='utf-8') as f:
            yaml.dump(config, f, allow_unicode=True, default_flow_style=False)
        "
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        
    - name: è¿è¡ŒAIå¢å¼ºæŠ¥å‘Šç”Ÿæˆå™¨
      run: |
        # ä½¿ç”¨ç°æœ‰çš„main.pyç”ŸæˆæŠ¥å‘Š
        python main.py
        
    - name: å‘é€AIå¢å¼ºé‚®ä»¶æŠ¥å‘Š
      run: |
        python send_ai_report_email.py
      continue-on-error: true  # å³ä½¿é‚®ä»¶å‘é€å¤±è´¥ä¹Ÿä¸å½±å“æ•´ä½“çŠ¶æ€
      
    - name: ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: daily-report-logs-${{ github.run_number }}
        path: |
          trendradar.log
          output/
        retention-days: 7