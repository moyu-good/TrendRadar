name: ğŸ“§ ä¼˜åŒ–ç‰ˆçƒ­ç‚¹æ–°é—»æ¨é€

on:
  schedule:
    # æ—¥æœ¬æ—¶é—´æ¯å¤©æ—©ä¸Š9ç‚¹æ¨é€ (åŒ—äº¬æ—¶é—´8ç‚¹)
    - cron: '0 1 * * *'  # UTC 01:00 = æ—¥æœ¬æ—¶é—´ 10:00 (è€ƒè™‘æ‰§è¡Œæ—¶é—´)
    - cron: '0 23 * * *'  # UTC 23:00 = æ—¥æœ¬æ—¶é—´ 8:00 (å¤‡é€‰æ—¶é—´)
  workflow_dispatch:

jobs:
  send-optimized-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: è·å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ config/config.yaml ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ config/frequency_words.txt ä¸å­˜åœ¨" 
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: è®¾ç½®æ—¶é—´çª—å£é…ç½®
        run: |
          # ç¡®ä¿æ¨é€æ—¶é—´çª—å£è®¾ç½®æ­£ç¡®
          python -c "
          import yaml
          import os
          
          with open('config/config.yaml', 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f)
          
          # ä¼˜åŒ–æ¨é€é…ç½®
          config['notification']['push_window']['enabled'] = True
          config['notification']['push_window']['once_per_day'] = True
          config['notification']['push_window']['time_range']['start'] = '08:00'  # åŒ—äº¬æ—¶é—´8ç‚¹
          config['notification']['push_window']['time_range']['end'] = '10:00'   # åŒ—äº¬æ—¶é—´10ç‚¹
          
          # ç¡®ä¿æŠ¥å‘Šæ¨¡å¼ä¸ºdaily
          config['report']['mode'] = 'daily'
          
          with open('config/config.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(config, f, allow_unicode=True, default_flow_style=False)
          
          echo "âœ… æ—¶é—´é…ç½®å·²ä¼˜åŒ–"
          "

      - name: è¿è¡Œçƒ­ç‚¹çˆ¬è™«
        env:
          # ä½¿ç”¨ç°æœ‰çš„é‚®ç®±é…ç½®
          EMAIL_FROM: ${{ secrets.EMAIL_FROM || '1249510763@qq.com' }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD || 'nvynsqarwowkbace' }}
          EMAIL_TO: ${{ secrets.EMAIL_TO || '1249510763@qq.com' }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || 'smtp.qq.com' }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '465' }}
          
          # å…¶ä»–é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          
          # å¯ç”¨GitHub Actionsæ¨¡å¼
          GITHUB_ACTIONS: true
          
        run: |
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆçƒ­ç‚¹æ–°é—»æŠ¥å‘Š..."
          python main.py
          echo "âœ… çƒ­ç‚¹æ–°é—»æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ç”ŸæˆAIå¢å¼ºæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
        if: success()
        run: |
          # å¦‚æœå­˜åœ¨AIå¢å¼ºæ¨¡å—ï¼Œåˆ™è¿è¡Œ
          if [ -f "simple_ai_report.py" ]; then
            echo "ğŸ¤– ç”ŸæˆAIå¢å¼ºæ‘˜è¦..."
            python simple_ai_report.py || echo "âš ï¸ AIå¢å¼ºåŠŸèƒ½è¿è¡Œå¤±è´¥ï¼Œä½†ä¸å½±å“ä¸»åŠŸèƒ½"
          fi

      - name: ä¸Šä¼ æŠ¥å‘Šå’Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: daily-report-${{ github.run_number }}
          path: |
            output/
            trendradar.log
          retention-days: 7

      - name: æ¸…ç†æ—§æŠ¥å‘Š
        if: success()
        run: |
          # æ¸…ç†7å¤©å‰çš„æŠ¥å‘Šæ–‡ä»¶
          find output/ -name "*.html" -type f -mtime +7 -delete || true
          find output/ -name "*.txt" -type f -mtime +7 -delete || true
          echo "ğŸ§¹ å·²æ¸…ç†æ—§æŠ¥å‘Šæ–‡ä»¶"